# アーキテクチャ設計

## フェーズ1: 基本環境のセットアップ

### 構成ファイル
- **index.html**: アプリケーションのエントリーポイント。CanvasやJSファイルの読み込みを行う
- **style.css**: 基本的なスタイル設定を行う
- **main.js**: Three.jsによる3D描画のメインロジックを含む

### Three.js初期設定
- **Scene**: 3Dオブジェクトを配置するシーン
- **Camera**: 3D空間を見るためのPerspectiveCamera（視野角75度、アスペクト比はウィンドウサイズに合わせる）
- **Renderer**: WebGLRendererを使用し、CanvasにThree.jsの描画結果を出力
- **Lighting**: 環境光(AmbientLight)と指向性ライト(DirectionalLight)を使用
  - 環境光: 全体を薄く照らす（輝度0.5）
  - 指向性ライト: 上方から強い光を当てる（輝度0.8）

### レンダリングループ
- requestAnimationFrameを使用した標準的なアニメーションループ
- ウィンドウリサイズ対応でレスポンシブ対応

## フェーズ2: コア要素の実装

### ゲーム要素
- **地面**: PlaneGeometryを使用し、MeshStandardMaterialで森林緑色に着色
  - 水平に配置するためにX軸周りに-90度回転
  - 幅10、長さ100の平面
  - プレイヤーの前方に配置（Z座標-45）

- **プレイヤー**: BoxGeometryを使用し、MeshStandardMaterialで赤色に着色
  - サイズ0.8x0.8x0.8の立方体
  - 地面の上に浮かせるためにY座標0.4に配置

### レーンシステム
- **レーン定義**: X座標[-3, -1, 1, 3]の4レーン
- **プレイヤー位置**: 初期位置は左から2番目のレーン（X座標1）

### 入力制御
- **左右移動**: 矢印キー（ArrowLeft, ArrowRight）でレーン間を移動
- **移動制限**: 最も左・最も右のレーンを超えた移動はできないよう制限

## フェーズ3: ゲームメカニクスの実装

### ゲーム進行
- **自動前進**: プレイヤーが毎フレームgameSpeed分だけZ軸方向に前進
- **カメラ追従**: プレイヤーと同じ速度でカメラもZ軸方向に移動

### 障害物システム
- **障害物**: BoxGeometryを使用し、MeshStandardMaterialで青色に着色
  - プレイヤーと同じサイズ（0.8x0.8x0.8）の立方体
  - 地面上に配置（プレイヤーと同じY座標0.4）

- **障害物生成**:
  - 一定間隔（obstacleDistance=20）ごとに生成
  - ランダムなレーンに配置
  - プレイヤーの前方（Z座標-50）に生成

- **障害物管理**:
  - obstacles配列で全ての障害物を追跡
  - カメラ後方に移動した障害物は自動削除

### 衝突判定
- **判定方法**: THREE.Box3を使用したバウンディングボックスの交差判定
- **現在の動作**: 衝突時にコンソールにメッセージを表示

## バグ修正
- **地面の表示問題**: カメラが移動するにつれて地面が画面外に出てしまう問題を修正
  - 地面の位置をカメラの位置に連動させ、常に視界内に地面が表示されるよう修正

## フェーズ4: ゲームフローとUIの実装

### ゲーム状態管理
- **状態変数**: gameStateで3つの状態を管理
  - initial: 初期状態（ゲーム開始前）
  - playing: プレイ中
  - gameOver: ゲームオーバー状態

- **状態遷移**:
  - initial → playing: スペースキーを押すとゲーム開始
  - playing → gameOver: 障害物に衝突するとゲームオーバー
  - gameOver → playing: Rキーを押すとリスタート

### UIシステム
- **HTML要素**:
  - スコア表示（右上）: #score
  - メッセージ表示（中央）: #message

- **CSS**:
  - 位置: absolute位置指定で画面上に配置
  - スタイリング: 半透明の背景、丸みを帯びた角、適切なフォントサイズと余白
  - pointer-events: noneでCanvasの操作を阻害しないよう設定

### スコアシステム
- **スコア計算**: プレイ中に毎フレームスコアが増加
- **表示更新**: パフォーマンスのため10点ごとに表示を更新

### ゲームフロー関数
- **startGame()**: ゲーム開始時の初期化とメッセージ非表示
- **gameOver()**: 衝突時の状態変更と最終スコア表示
- **restartGame()**: 全ての状態をリセットし、ゲームを再開

## バージョン1.1: スピードアップアイテム機能の追加

### 速度管理システム
- **速度変数の改良**:
  - `baseSpeed`: 基本速度（0.15）を定義
  - `currentGameSpeed`: 現在のゲーム速度を管理
  - プレイヤーとカメラの移動に`currentGameSpeed`を使用するよう変更

### アイテムシステム
- **アイテム**: SphereGeometryを使用し、MeshStandardMaterialで黄色に着色
  - サイズ0.5、セグメント数16の球体
  - 地面上に配置（プレイヤーと同じY座標0.4）

- **アイテム生成**:
  - 障害物と同様の間隔（obstacleDistance=20）で生成
  - 1/3の確率でアイテム、2/3の確率で障害物を生成
  - ランダムなレーンに配置
  - プレイヤーの前方（Z座標-50）に生成

- **アイテム管理**:
  - items配列で全てのアイテムを追跡
  - カメラ後方に移動したアイテムは自動削除

### スピードアップ効果
- **効果パラメータ**:
  - `speedBoostMultiplier`: スピードアップの倍率（1.5倍）
  - `boostDuration`: 効果時間（5000ミリ秒 = 5秒）

- **効果管理変数**:
  - `isBoosted`: スピードアップ効果が有効かどうかを示すフラグ
  - `boostTimeoutId`: タイマーID（効果時間管理用）

- **アイテム獲得処理**:
  - `collectItem()`: アイテム獲得時の処理を行う関数
    - アイテムをシーンと配列から削除
    - 速度を「基本速度×倍率」に設定
    - タイマーを設定し、効果時間後に速度を元に戻す

- **効果の重複対応**:
  - アイテム獲得時に既にスピードアップ中の場合、既存のタイマーをキャンセルし、効果時間をリセット

### リスタート時の処理拡張
- **アイテム関連のリセット**:
  - items配列の全アイテムを削除
  - スピードアップ効果のタイマーをキャンセル
  - 速度を基本速度に戻す
  - 効果フラグをリセット

## Ver 1.1: スピードアップアイテム機能追加版

### データ構造
- `items` 配列: 生成されたアイテムオブジェクトを管理
- アイテム関連の状態変数:
  - `isBoosted`: スピードアップ効果が有効かどうかのフラグ
  - `boostTimeoutId`: スピードアップ効果のタイマーID
  - `baseSpeed`: 基本速度（定数）
  - `currentGameSpeed`: 現在の速度（変数）
  - `speedBoostMultiplier`: スピードアップの倍率（定数）
  - `boostDuration`: スピードアップの効果時間（定数）

### 機能コンポーネント
- `createItemMesh(laneIndex, zPos)`: 指定のレーンとZ座標にアイテムを作成
- `collectItem(item)`: アイテム獲得時の処理（効果適用、アイテム削除）

### 処理フロー
1. ゲームループ内で一定確率でアイテムを生成
2. アイテムとプレイヤーの衝突判定
3. 衝突時、アイテム効果を適用（速度アップ）
4. タイマーで一定時間後に効果を解除
5. リスタート時にアイテム関連の状態をリセット

## Ver 1.2: ビジュアルエフェクト追加版

### データ構造
- `trailParticles` 配列: プレイヤーの後ろに表示されるトレイルエフェクト用パーティクル情報を管理
- `laneMarkers` 配列: レーン変更時に表示されるマーカーオブジェクトを管理
- `itemEffects` 配列: アイテム獲得時のアニメーション情報を管理
- `debrisParticles` 配列: 障害物衝突時の破片オブジェクトを管理
- パーティクルシステム関連:
  - `particleGeometry`: パーティクル用のBufferGeometry
  - `particleMaterial`: パーティクル用のPointsMaterial
  - `particleSystem`: パーティクル表示用のPointsオブジェクト
- 画面シェイク関連:
  - `isShaking`: シェイク中かどうかのフラグ
  - `shakeIntensity`: シェイクの強度
  - `shakeDuration`: シェイクの持続時間
  - `shakeElapsed`: シェイク開始からの経過時間
  - `originalCameraPosition`: シェイク前のカメラ位置

### 機能コンポーネント
- パーティクル関連:
  - `emitParticle()`: プレイヤーの後方にパーティクルを生成
  - `updateParticles(deltaTime)`: パーティクルの位置、寿命、透明度を更新
- マーカー関連:
  - `createLaneMarker(x, z)`: 指定位置にレーンマーカーを生成
  - `updateMarkers(deltaTime)`: マーカーのフェードアウトと削除を管理
- アイテムエフェクト関連:
  - `updateItemEffects(deltaTime)`: アイテムのスケールアニメーションと透明度を更新
- 障害物衝突エフェクト関連:
  - `shakeCamera(duration, intensity)`: 指定パラメータでカメラシェイクを開始
  - `createDebris(position, color)`: 指定位置と色で破片を生成
  - `updateDebris(deltaTime)`: 破片の移動、回転、寿命を更新

### 処理フロー
1. デルタタイム計算: フレームレート非依存の更新を実現
2. トレイルエフェクト: 一定間隔でプレイヤー後方にパーティクルを生成
3. レーン変更時: マーカーを生成し、徐々にフェードアウト
4. アイテム獲得時: アイテムを拡大させながらフェードアウト
5. 障害物衝突時: 
   - カメラを一定時間揺らすシェイク効果を適用
   - 障害物の位置に破片を生成し、物理的に散らばるアニメーション
6. 各種エフェクトの更新: デルタタイムに基づく更新処理
7. リスタート時: すべてのエフェクト関連の配列とオブジェクトをクリア
