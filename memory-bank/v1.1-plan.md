# 実装プラン - スピードアップアイテム追加 - Ver 1.0

このプランは、完成済みのエンドレスランナーMVPに対し、「スピードアップアイテム」機能を追加実装するための手順を示します。GDD Ver 1.1 のアイテム関連仕様に基づきます。

## 前提条件

* エンドレスランナーのMVP（GDD Ver 1.0 相当）が実装済みであること。
    * プレイヤーの自動前進、左右レーン移動、障害物の生成・削除、衝突判定（ゲームオーバー）、スコア表示、ゲーム状態管理（開始、プレイ中、ゲームオーバー、リスタート）が動作している。

## フェーズ 1: アイテムの準備と表示

1.  **1-1. 速度変数の導入と適用:**
    * 既存のプレイヤー/カメラの前進速度を管理している部分を修正します。
    * 基本速度 `baseSpeed` と、現在のゲーム速度 `currentGameSpeed` をグローバル変数またはクラスのプロパティとして定義します。
    * ゲーム開始時およびリスタート時に `currentGameSpeed = baseSpeed;` と初期化します。
    * プレイヤーとカメラの前進処理（`animate` 関数内など）で、固定値ではなく `currentGameSpeed` を使用するように変更します。
    * **テスト:** ゲームを実行し、以前と同様の基本速度でプレイヤーとカメラが前進することを確認します。

2.  **1-2. アイテム用メッシュ生成関数の作成:**
    * アイテムの見た目となる `THREE.Mesh` を作成する関数 `createItemMesh()` を実装します。
    * 障害物とは異なる形状 (`THREE.SphereGeometry` など) や色 (`THREE.MeshBasicMaterial` の色を変更) を使用します。
    * **テスト:** この関数を一時的に呼び出し、意図した見た目のアイテムメッシュが生成されることを確認します。

3.  **1-3. アイテム管理用配列の準備:**
    * アクティブなアイテムオブジェクトを管理するための空の配列 `items = [];` をグローバル変数またはクラスのプロパティとして定義します。
    * **テスト:** コードレビュー。

## フェーズ 2: アイテムの生成・削除ロジックの組み込み

4.  **2-1. オブジェクト生成ロジックの変更:**
    * 既存の障害物生成ロジック（一定距離ごと、またはタイマーで実行される部分）を修正します。
    * オブジェクトを生成するタイミングで、`Math.random()` などを用いて確率計算を行います (例: 1/3 の確率)。
    * 確率に基づいて、`createItemMesh()` または既存の `createObstacleMesh()` のどちらを呼び出すか分岐させます。
    * 生成されたオブジェクトがアイテムの場合は `items` 配列に、障害物の場合は既存の `obstacles` 配列に追加します。
    * 生成されたオブジェクトをシーンに追加します。
    * **テスト:** ゲームを実行し、障害物に加えてアイテムが適切な頻度（およそ1/3）で、ランダムなレーンに出現することを確認します。

5.  **2-2. アイテム削除ロジックの追加:**
    * 既存の画面外オブジェクト削除ロジック（`animate` 関数内など）に、`items` 配列に対する処理を追加します。
    * `items` 配列をループし、各アイテムが画面外（プレイヤーの後方）に出たかどうかをチェックします。
    * 画面外に出たアイテムを `scene.remove()` でシーンから削除し、`items` 配列からも削除します。
    * **テスト:** ゲームをしばらく実行し、古いアイテムが適切に削除され、`items` 配列の要素数が無限に増え続けないことを確認します。

## フェーズ 3: アイテム獲得と効果の実装

6.  **3-1. アイテム用衝突判定の追加:**
    * `animate` 関数内の `gameState === 'playing'` ブロックに、アイテムとの衝突判定処理を追加します。
    * プレイヤーのバウンディングボックスを取得します。
    * `items` 配列をループし、各アイテムのバウンディングボックスを取得して、プレイヤーと交差 (`intersectsBox`) するかチェックします。
    * 衝突が検知されたアイテムが見つかった場合、そのアイテムを引数としてアイテム獲得処理（次のステップで実装）を呼び出します。衝突したアイテムは複数同時に処理せず、1フレームにつき1つ獲得するなどの考慮が必要な場合があります。
    * **テスト:** プレイヤーをアイテムに接触させ、衝突が検知されること（例: コンソールログ）を確認します。

7.  **3-2. アイテム獲得処理の実装:**
    * アイテム獲得時に呼び出される関数 `collectItem(item)` を実装します。
    * この関数内で以下を行います:
        * 引数で受け取った `item` を `scene.remove()` でシーンから削除します。
        * `items` 配列から該当する `item` を削除します。
        * スピードアップ効果を開始する処理（次のステップで実装）を呼び出します。
    * **テスト:** アイテムに接触すると、そのアイテムが画面から消えることを確認します。`items` 配列からも削除されていることを（デバッガなどで）確認します。

8.  **3-3. スピードアップ効果の実装:**
    * スピードアップの倍率 (`speedBoostMultiplier = 1.5;` など) と効果時間 (`boostDuration = 5000;` // ミリ秒) を定数または設定値として定義します。
    * スピードアップ効果が有効かどうかを示すフラグ変数 (`isBoosted = false;`) と、効果解除用のタイマーIDを保持する変数 (`boostTimeoutId = null;`) を用意します。
    * `collectItem` 関数内で、スピードアップ効果を開始する処理を実装します:
        * もし既にスピードアップ中 (`boostTimeoutId` が存在する) なら、既存のタイマーを `clearTimeout(boostTimeoutId);` でキャンセルします（効果時間をリセットするため）。
        * `currentGameSpeed = baseSpeed * speedBoostMultiplier;` を設定します。
        * `isBoosted = true;` (任意: UI表示などに使う場合)
        * `boostTimeoutId = setTimeout(() => { currentGameSpeed = baseSpeed; isBoosted = false; boostTimeoutId = null; }, boostDuration);` を実行し、タイマーIDを保存します。
    * **テスト:** アイテムを獲得すると、プレイヤーとカメラの移動速度が `boostDuration` で指定した時間だけ速くなり、その後自動的に元の速度 (`baseSpeed`) に戻ることを確認します。スピードアップ中に再度アイテムを獲得すると、効果時間が延長（リセット）されることを確認します。

## フェーズ 4: 既存機能への反映と調整

9.  **4-1. リスタート処理の修正:**
    * 既存のリスタート処理（'R' キー押下時など）に以下を追加します。
        * `items` 配列に残っているアイテムをすべてシーンから削除し、配列を空にします (`items.forEach(item => scene.remove(item)); items = [];`)。
        * `currentGameSpeed` を `baseSpeed` にリセットします。
        * もしスピードアップ効果中であれば、`clearTimeout(boostTimeoutId);` でタイマーをキャンセルし、関連フラグ (`isBoosted`, `boostTimeoutId`) をリセットします。
    * **テスト:** スピードアップ中にゲームオーバーになり、'R' でリスタートした際に、速度が正常な基本速度に戻り、古いアイテムが残っていないことを確認します。

10. **4-2. パラメータ調整:**
    * アイテムの出現確率、スピードアップの倍率 (`speedBoostMultiplier`)、効果時間 (`boostDuration`) を調整し、ゲームバランスを整えます。
    * **テスト:** 実際にプレイし、アイテムの効果がゲームプレイに良い影響を与えているか、難易度が適切かを確認します。

11. **4-3. 総合テスト:**
    * アイテムの出現、獲得、スピードアップ効果の発動と解除、リスタート時のリセットなど、アイテム関連機能が一通り正しく動作することを確認します。
    * 既存の障害物との衝突判定やゲームオーバー処理に影響が出ていないかも確認します。

---

このプランに沿って実装を進めることで、既存のMVPにスピードアップアイテム機能を追加できるはずです。
